<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Perplexity</title>
<meta name="description" content="An amazing website.">


  <meta name="author" content="Your Name">
  


<meta property="og:type" content="website">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Perplexity">
<meta property="og:title" content="Perplexity">
<meta property="og:url" content="http://blog.inductorsoftware.com/Perplexity/home/pxint/pxint0071WhichParseAndTree/">


  <meta property="og:description" content="An amazing website.">











  

  


<link rel="canonical" href="http://blog.inductorsoftware.com/Perplexity/home/pxint/pxint0071WhichParseAndTree/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Your Name",
      "url": "http://blog.inductorsoftware.com/Perplexity/home/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/Perplexity/home/feed.xml" type="application/atom+xml" rel="alternate" title="Perplexity Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/Perplexity/home/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--delphin_page wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/Perplexity/home/"><img src="/Perplexity/home/assets/images/Delph-In.png" alt="Perplexity"></a>
        
        <a class="site-title" href="/Perplexity/home/">
          Perplexity
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="https://blog.inductorsoftware.com/Perplexity/home/devOverview">Home</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <i class="fas fa-search"></i>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Developer Tutorial Overview</span>
        

        
        <ul>
          
            <li><a href="/Perplexity/home/devOverview/">Overview</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">MRS Conceptual</span>
        

        
        <ul>
          
            <li><a href="/Perplexity/home/mrscon/devhowto0010MRS/">Minimal Recursion Semantics (MRS)</a></li>
          
            <li><a href="/Perplexity/home/mrscon/devhowto0020WellFormedTree/">Well-Formed Trees</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">MRS Solver Conceptual</span>
        

        
        <ul>
          
            <li><a href="/Perplexity/home/devcon/devcon0000Overview/">Overview</a></li>
          
            <li><a href="/Perplexity/home/devcon/devcon0010MRSSolver/">Backtracking</a></li>
          
            <li><a href="/Perplexity/home/devcon/devcon0020MRSSolverSets/">Representing 'Together'</a></li>
          
            <li><a href="/Perplexity/home/devcon/devcon0030MRSSolverSolutionGroups/">Collective, Distributive, Cumulative</a></li>
          
            <li><a href="/Perplexity/home/devcon/devcon0060WhichParseAndTree/">Choosing a Parse and Tree</a></li>
          
            <li><a href="/Perplexity/home/devcon/devcon0070SentenceForce/">Sentence Types</a></li>
          
            <li><a href="/Perplexity/home/devcon/devcon0080ErrorsChoosingWhichFailure/">Choosing a Failure</a></li>
          
            <li><a href="/Perplexity/home/devcon/devcon0040MRSSolverSolutionGroupsAlgorithm/">A. Implementing Solution Groups</a></li>
          
            <li><a href="/Perplexity/home/devcon/devcon0050MRSSolverSolutionCombinations/">B. Optimizing Solution Groups</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Using Perplexity</span>
        

        
        <ul>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo010Overview/">Overview</a></li>
          
            <li><a href="/Perplexity/home/pxHowTo/pxHowTo012Install/">Installing Perplexity</a></li>
          
            <li><a href="/Perplexity/home/pxHowTo/pxHowTo014HelloWorld/">Hello World</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo020ImplementAPredication/">Implementing a Predication</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo022Testing/">Testing</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo030InStylePredications/">In-Style Predications</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo040LiftStylePredications/">Lift-Style Predications</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo050EventPredications/">Event Predications</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo070ActionVerbs/">Verb Predications</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo082State/">Custom State</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo085Place/">Representing Places</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo090Prepositions/">Directional Propositions</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo100NonlogicalMeaning/">Solution Group Handlers and Non-logical Meaning</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo105GlobalCriteria/">Solution Group Handlers and Global Criteria</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo110HandlingTenses/">Handling Tenses</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo120ConceptsReferringExpressions/">Conceptual References</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo080QuantifiersAndDeterminers/">Quantifiers and Determiners</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo130OpenClassWords/">Centralizing Nouns/Adjectives</a></li>
          
            <li><a href="/Perplexity/home/pxhowto/pxHowTo025SStrings/">A. Generating English with S-strings</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Perplexity Internals</span>
        

        
        <ul>
          
            <li><a href="/Perplexity/home/pxint/pxint0000Overview/">Overview</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0010PredicationContract/">The Predication Contract</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0020PythonBasics/">State and Python Basics</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0030ImplementPredication/">Implementing a Predication</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0040BuildSolver/">Initial Solver</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0050Conjunctions/">Solving Conjunctions</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0060ScopalArguments/">Solving Scopal Arguments</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0080SimplePropositions/">Propositions</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0090SimpleQuestions/">Questions</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0100SimpleCommands/">Commands</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0105ErrorsChoosingWhichFailure/">Choosing a Failure</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0110ErrorsReportingAFailure/">Naive Failure Text</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0120ErrorsConceptualFailures/">English Variable Domains</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0070GenerateMRSAndTrees/">Generating MRS and Trees</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0071WhichParseAndTree/" class="active">Choosing a Parse and Tree</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint0230Summary/">Summary</a></li>
          
            <li><a href="/Perplexity/home/pxint/pxint03000PythonDecorators/">A. Python Decorators</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>

    
  
  </div>



  <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
    
    
    
    

    <div class="page__inner-wrap">
      
        <header>
          


        </header>
      

      <section class="page__content e-content" itemprop="text">
        
        <h2 id="determining-the-right-parse-and-tree">Determining the Right Parse and Tree</h2>
<p>In the <a href="https://blog.inductorsoftware.com/Perplexity/home/pxint/pxint0070GenerateMRSAndTrees">previous section</a>, we wrote the code to generate all the parses for a phrase, and all the fully-resolved MRS trees that result from. Next we have to decide which one is the one the user intended and write the code to run it. As discussed in the conceptual topic on <a href="https://blog.inductorsoftware.com/Perplexity/home/devcon/devcon0060WhichParseAndTree">Choosing a Parse and Tree</a>, returning the response from the first MRS parse and tree that succeeded (or failed) is good heuristic to use in general.</p>

<p>To implement the code for choosing the right tree, we’re going to create a new class that will be the main entry point into the whole system. It is called <code class="language-plaintext highlighter-rouge">UserInterface</code> and its main method is <code class="language-plaintext highlighter-rouge">interact_once()</code>. Each call to that method does a single “command/response” interaction with the system mostly using code we’ve already written. Here’s a summary of its logic:</p>

<ol>
  <li>Use the code we wrote in the <a href="https://blog.inductorsoftware.com/Perplexity/home/pxint/pxint0070GenerateMRSAndTrees">previous topic</a> to convert the phrase to MRS and then generate the trees for the MRS, go through them in order.</li>
  <li>Solve the trees using a modification to the <code class="language-plaintext highlighter-rouge">call()</code> function from <a href="https://blog.inductorsoftware.com/Perplexity/home/pxint/pxint0050Conjunctions">Conjunctions topic</a> which is called <code class="language-plaintext highlighter-rouge">solve</code>. Go through these in order.</li>
  <li>If an error occurs when solving a tree, get a string for it by calling <code class="language-plaintext highlighter-rouge">generate_message_with_index</code> (which gets passed as an argument to <code class="language-plaintext highlighter-rouge">interact_once</code>). We built this in the <a href="https://blog.inductorsoftware.com/Perplexity/home/pxint/pxint0120ErrorsConceptualFailures">English Domain Names section</a></li>
  <li>When we are done, actually respond using the (slightly refactored) <code class="language-plaintext highlighter-rouge">respond_to_solutions()</code> function we built in <a href="https://blog.inductorsoftware.com/Perplexity/home/pxint/pxint0080SimplePropositions">the Propositions Section</a></li>
</ol>

<p>The new code is at the end of the function, where we apply all the operations to a single state object and then store it away as the new state.  Otherwise, changes would just get discarded and the next interaction wouldn’t see them.</p>

<p>Our new code iterates through every MRS, then every tree it has.  If the function succeeds on a particular tree, it stops processing. Otherwise, it continues until it finds a succcess or runs out of trees. If nothing succeeds, it will report the first tree failure.</p>

<p>Here is the full code for it:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class UserInterface(object):
    def __init__(self, state, vocabulary):
        self.max_holes = 13
        self.state = state
        self.execution_context = ExecutionContext()
        self.vocabulary = vocabulary

    # response_function gets passed three arguments:
    #   response_function(mrs, solutions, error)
    # It must use them to return a string to say to the user
    def interact_once(self, response_function):
        # input() pauses the program and waits for the user to
        # type input and hit enter, and then returns it
        user_input = str(input("? "))
        best_failure = None

        # Loop through each MRS and each tree that can be
        # generated from it...
        for mrs_raw in self.mrss_from_phrase(user_input):
            for tree in self.trees_from_mrs(mrs_raw):
                print(tree)
                # Collect all the solutions for this tree against the
                # current world state
                mrs = {"Index": mrs_raw.index,
                       "Variables": mrs_raw.variables,
                       "RELS": tree}

                call_state = self.state.set_x("mrs", (mrs, ))
                solutions = []
                try:
                    for item in context().solve(vocabulary, call_state, mrs["RELS"]):
                        solutions.append(item)
                except NotImplementedError as e:
                    print(str(e))
                    continue

                # Determine the response to it
                error_text = response_function(call_state,
                                               context().deepest_error_predication_index(),
                                               context().deepest_error()) if len(solutions) == 0 else None

                message = respond_to_solutions(call_state, mrs, solutions, error_text)
                if len(solutions) &gt; 0:
                    # This worked, give a response
                    print(message)

                    # apply the results to the current world state if it was a command
                    if sentence_force(mrs) == "comm":
                        self.state = self.apply_solutions_to_state(self.state, solutions)
                        print(f"New state: {str(self.state.objects)}")

                    return
                else:
                    # This failed, remember it if it is the "best" failure
                    # which we currently define as the first one
                    if best_failure is None:
                        best_failure = message

        # If we got here, nothing worked: print out the best failure
        print(best_failure)
        
        ...
</code></pre></div></div>

<p>Here is the modified <code class="language-plaintext highlighter-rouge">ExecutionContext</code> that has the new <code class="language-plaintext highlighter-rouge">solve()</code> method that is only there to reset the predication index since it can now be called multiple times as we process new phrases:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class ExecutionContext(object):
    def __init__(self):
        self.reset()

    def reset(self):
        self._error = None
        self._error_predication_index = -1
        self._predication_index = -1

    def solve(self, vocabulary, state, term):
        self.reset()
        yield from call(vocabulary, state, term)

    def call(self, vocabulary, state, term):
        ...
        
    ...
</code></pre></div></div>

<p>Below is the modified <code class="language-plaintext highlighter-rouge">respond_to_solutions()</code> function. It no longer generates solutions or error text, instead it requires the caller to pass them in. That allows us to centralize the code that does the solving into <code class="language-plaintext highlighter-rouge">interact_once()</code>.  It also returns the response instead of printing it now.  The rest of the code is the same:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def respond_to_solutions(state, mrs, solutions, error_text):
    force = sentence_force(mrs)
    if force == "prop":
        # This was a proposition, so the user only expects
        # a confirmation or denial of what they said.
        # The phrase was "true" if there was at least one answer
        if len(solutions) &gt; 0:
            return "Yes, that is true."
        else:
            return f"No, that isn't correct: {error_text}"

    elif force == "ques":
        # See if this is a "WH" type question
        wh_predication = find_predication(mrs["RELS"], "_which_q")
        if wh_predication is None:
            # This was a simple question, so the user only expects
            # a yes or no.
            # The phrase was "true" if there was at least one answer
            if len(solutions) &gt; 0:
                return "Yes."
            else:
                return f"No, {error_text}"
        else:
            # This was a "WH" question
            # return the values of the variable asked about
            # from the solution
            # The phrase was "true" if there was at least one answer
            if len(solutions) &gt; 0:
                wh_variable = wh_predication.args[0]
                for solutions in solutions:
                    return f"{str(solutions.get_binding(wh_variable).value)}"
            else:
                return f"{error_text}"

    elif force == "comm":
        # This was a command so, if it works, just say so
        # We'll get better errors and messages in upcoming sections
        if len(solutions) &gt; 0:
            return f"Done!"
        else:
            return f"Couldn't do that: {error_text}"
</code></pre></div></div>

<p>We also moved the functions that parse and build trees (<code class="language-plaintext highlighter-rouge">mrss_from_phrase</code>, <code class="language-plaintext highlighter-rouge">tree_from_assignments</code> and <code class="language-plaintext highlighter-rouge">trees_from_mrs</code>) to be part of the <code class="language-plaintext highlighter-rouge">UserInterface</code> class just to clean up the code.</p>

<p>With this, we now have a (simple) fully-functioning interactive natural language system! Here’s a simple example that runs it in a loop, and an interactive session using some phrases we’ve used throughout the tutorial to test it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def Example12():
    state = State([Actor(name="Computer", person=2),
                   Folder(name="Desktop"),
                   Folder(name="Documents"),
                   File(name="file1.txt", size=2000000),
                   File(name="file2.txt", size=100)])

    user_interface = UserInterface(state, vocabulary)

    while True:
        user_interface.interact_once(generate_message_with_index)
        print()
        
</code></pre></div></div>

<p>Running that sample leaves you at the command prompt waiting for you to interact.  Here’s a session that runs all the phrases we’ve done in previous sections:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>? a file is large
[_a_q(x3,[_file_n_of(x3,i8)],[_large_a_1(e2,x3)])]
Yes, that is true.

? which file is large?
[_which_q(x3,[_file_n_of(x3,i8)],[_large_a_1(e2,x3)])]
(File(file1.txt, 2000000),)

? delete a large file
[_a_q(x4,[_large_a_1(e9,x4), _file_n_of(x4,i10)],[_delete_v_1(e2,i3,x4)])]
Implementation for Predication _delete_v_1(e2,i3,x4) not found
[pronoun_q(x3,[pron(x3)],[_a_q(x8,[_large_a_1(e13,x8), _file_n_of(x8,i14)],[_delete_v_1(e2,x3,x8)])])]
Done!
New state: [Actor(name=Computer, person=2), Folder(Desktop), Folder(Documents), File(file2.txt, 100)]

? which file is large?
[_which_q(x3,[_file_n_of(x3,i8)],[_large_a_1(e2,x3)])]
[udef_q(x3,[_which_q(x10,[generic_entity(x10)],[nominalization(x3,[_file_v_1(e14,x10,i15)])])],[_large_a_1(e2,x3)])]
Implementation for Predication udef_q(x3,[_which_q(x10,[generic_entity(x10)],[nominalization(x3,[_file_v_1(e14,x10,i15)])])],[_large_a_1(e2,x3)]) not found
[_which_q(x10,[generic_entity(x10)],[udef_q(x3,[nominalization(x3,[_file_v_1(e14,x10,i15)])],[_large_a_1(e2,x3)])])]
Implementation for Predication generic_entity(x10) not found
which file is not large

? which folder is large?
[_which_q(x3,[_folder_n_of(x3,i8)],[_large_a_1(e2,x3)])]
which folder is not large

? a folder is large
[_a_q(x3,[_folder_n_of(x3,i8)],[_large_a_1(e2,x3)])]
No, that isn't correct: a folder is not large
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">interact_once()</code> prints out the trees that get found so it is easier to see which is being used and which have missing predications. It also helps point out when a tree failed and the solver is trying more trees to find a success. You can see that in action by looking at the difference between the first “which file is large?” which only generates one tree since it succeeds, and the second one which fails since there are no large files.  The second one keeps going trying to find a tree that works.</p>

<blockquote>
  <p>Comprehensive source for the completed tutorial is available <a href="https://github.com/EricZinda/Perplexity">here</a>.</p>
</blockquote>

<p>Last update: 2024-10-23 by Eric Zinda [<a href="https://github.com/EricZinda/Perplexity/edit/main/docs/pxint/pxint0071WhichParseAndTree.md">edit</a>]</p>

        
      </section>

      <footer class="page__meta">
        
        


        


      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

<!--Scroll the navbar to the current page-->
<script type="text/javascript">
  let el = document.querySelector('.nav__list .active');
  if(el){
    el.scrollIntoView({block: "center", inline: "start"});
  }
</script>
    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
      
        
      
        
      
        
      
        
      
        
      
    

    
      <li><a href="/Perplexity/home/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 Your Name. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/Perplexity/home/assets/js/main.min.js"></script>




<script src="/Perplexity/home/assets/js/lunr/lunr.min.js"></script>
<script src="/Perplexity/home/assets/js/lunr/lunr-store.js"></script>
<script src="/Perplexity/home/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
